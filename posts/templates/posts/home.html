{% load static %} {% load humanize %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Crow ‚Äì Community Feed</title>

    <!-- Bootstrap CSS (for responsive layout & styling) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      /* ===== Page-wide styling ===== */
      body {
        background-color: #f6f7f8; /* light gray background like Reddit */
        font-family: "Inter", "Segoe UI", Arial, sans-serif; /* clean readable font */
      }

      h1 {
        font-weight: 700;
        color: #212529; /* dark gray text */
      }

      /* ===== Card Styling ===== */
      .card {
        border-radius: 12px; /* smooth edges */
        border: 1px solid #e0e0e0; /* subtle border */
      }

      /* Upvote button style */
      .btn-outline-success {
        border-radius: 20px;
        font-weight: 500;
      }

      /* Layout for the upvote section */
      .upvote-section {
        display: flex;
        align-items: center;
        gap: 6px;
      }
    </style>
  </head>

  <body class="bg-light">
    <!-- ====== MAIN CONTAINER ====== -->
    <div class="container py-5">
      <!-- ====== Page Title ====== -->
      <h1 class="text-center mb-5">Crow ü™∂ Community Feed</h1>

      <!-- ========================== -->
      <!-- SUCCESS / INFO MESSAGES -->
      <!-- ========================== -->
      {% if messages %} {% for message in messages %}
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      {% endfor %} {% endif %}

      <!-- ================================================== -->
      <!--  SECTION 1 : CREATE A POST                         -->
      <!-- ================================================== -->
      <div class="card shadow-sm mb-5">
        <div class="card-body">
          <!-- Section title -->
          <h4 class="card-title mb-3">Create a Post</h4>

          <!-- ========= POST CREATION FORM ========= -->
          <!-- This form lets users add new posts -->
          <form method="POST" class="mb-4">
            {% csrf_token %}

            <!-- Post Title Input -->
            {{ form.title.label_tag }} {{ form.title }}

            <!-- Post Content Box -->
            {{ form.content.label_tag }} {{ form.content }}

            <!-- ========================== -->
            <!-- Category Search Input -->
            <!-- ========================== -->
            <!-- When user types here, suggestions appear below (using JS + AJAX) -->
            <label for="categoryInput" class="form-label mt-3">Category</label>
            <!-- User types category name here -->
            <input
              type="text"
              id="categoryInput"
              name="category_name"
              class="form-control"
              placeholder="Start typing a category..."
            />

            <!-- Suggestion list (hidden by default, will show results below input) -->
            <div
              id="categorySuggestions"
              class="border rounded bg-white mt-1"
              style="
                display: none;
                position: absolute;
                z-index: 1000;
                width: 92%;
              "
            ></div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary mt-3">
              Share Post
            </button>
          </form>
        </div>
      </div>

      <!-- ================================================== -->
      <!--  SECTION 2 : DISPLAY ALL EXISTING POSTS             -->
      <!-- ================================================== -->
      <h3 class="fw-semibold mb-4">Latest Posts</h3>

      <!-- Loop through all posts from database -->
      {% for post in posts %}
      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <!-- Post title -->
          <h5 class="card-title mb-1">{{ post.title }}</h5>

          <!-- Post author and creation time -->
          <h6 class="card-subtitle mb-3 text-muted">
            by {{ post.author.username }} ‚Ä¢ {{ post.created_at|naturaltime }}
          </h6>

          <!-- Main post content -->
          <p class="card-text">{{ post.content }}</p>

          <!-- Display category name if available -->
          {% if post.category %}
          <p class="text-secondary">
            <small>Category: {{ post.category.name }}</small>
          </p>
          {% endif %}

          <!-- ========================== -->
          <!-- Upvote Button Section -->
          <!-- ========================== -->
          <!-- Clicking this increases the post's upvote count -->
          <form
            action="{% url 'upvote_post' post.id %}"
            method="post"
            class="upvote-section"
          >
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-success btn-sm">
              üî• Upvote
            </button>
            <span class="text-secondary">{{ post.upvotes }} upvotes</span>
          </form>
        </div>
      </div>

      <!-- If there are no posts at all, show a message -->
      {% empty %}
      <p class="text-muted">No posts yet. Be the first to share something!</p>
      {% endfor %}
    </div>

    <!-- ================================================== -->
    <!--  BOOTSTRAP JS (for dropdowns, buttons, etc.)        -->
    <!-- ================================================== -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ================================================== -->
    <!--  CATEGORY AUTO-SUGGEST + CREATE FEATURE -->
    <!-- ================================================== -->
    <script>
      /*
    This script listens for typing in the category box.
    It:
    1Ô∏è Fetches existing category suggestions from Django (via AJAX).
    2Ô∏è Shows them live below the input box.
    3Ô∏è If user‚Äôs category doesn‚Äôt exist ‚Üí shows ‚Äú‚ûï Create ‚Äò<name>‚Äô‚Äù option.
    4Ô∏è When clicked, fills the input box automatically.
    */
      const input = document.getElementById("categoryInput"); // text input box
      const suggestionBox = document.getElementById("categorySuggestions"); // suggestion box below input

      // This event runs every time the user types a key
      input.addEventListener("keyup", function () {
        const query = input.value.trim(); // get what user typed

        // If nothing typed, hide suggestions
        if (!query) {
          suggestionBox.style.display = "none";
          suggestionBox.innerHTML = "";
          return;
        }

        // Send AJAX request to backend API
        fetch(`/categories/search/?q=${query}`)
          .then((response) => response.json()) // convert response to JSON
          .then((data) => {
            const results = data.results; // get list of matching categories
            const exists = data.exists; // does category already exist?
            const typed = data.typed; // what user typed

            //  If the typed word matches an existing category exactly, hide suggestions
            if (exists) {
              suggestionBox.style.display = "none";
              suggestionBox.innerHTML = "";
              return;
            }

            // Build HTML for other suggestions
            let html = "";

            if (results.length > 0) {
              html += results
                .map(
                  (item) =>
                    `<div class="p-2 suggestion-item" style="cursor:pointer">${item}</div>`
                )
                .join("");
            }

            if (!exists && typed.length > 0) {
              html += `<div class="p-2 text-primary fw-semibold suggestion-create" style="cursor:pointer; background-color:#f8f9fa;">
                  ‚ûï Create "${typed}" category
               </div>`;
            }

            if (html === "") {
              html = '<div class="p-2 text-muted">No categories found</div>';
            }

            suggestionBox.innerHTML = html;
            suggestionBox.style.display = "block";

            // Handle click for existing category
            document.querySelectorAll(".suggestion-item").forEach((item) => {
              item.addEventListener("click", () => {
                input.value = item.textContent;
                suggestionBox.style.display = "none";
              });
            });

            /*
            Hide category suggestion box when clicking outside
            or pressing Tab to move away.
            */

            document.addEventListener("click", function (e) {
              // if click is outside both input and suggestion box ‚Üí hide box
              if (
                !e.target.closest("#categoryInput") &&
                !e.target.closest("#categorySuggestions")
              ) {
                suggestionBox.style.display = "none";
              }
            });

            // Hide on Tab key (focus leaves the input)
            input.addEventListener("keydown", function (e) {
              if (e.key === "Tab") {
                suggestionBox.style.display = "none";
              }
            });
            
            // Handle click for create new
            const createOption = document.querySelector(".suggestion-create");
            if (createOption) {
              createOption.addEventListener("click", () => {
                input.value = typed;
                suggestionBox.style.display = "none";
                alert(
                  `"${typed}" will be created automatically when you post!`
                );
              });
            }
          })
          .catch((error) => console.error("Error fetching categories:", error));
      });
    </script>
  </body>
</html>
