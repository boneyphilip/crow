{% load static %} {% load humanize %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Crow â€“ Community Feed</title>

    <!-- Bootstrap CSS (for responsive layout & styling) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      /* ===== Page-wide styling ===== */
      body {
        background-color: #f6f7f8; /* light gray background like Reddit */
        font-family: "Inter", "Segoe UI", Arial, sans-serif; /* clean readable font */
      }

      h1 {
        font-weight: 700;
        color: #212529; /* dark gray text */
      }

      /* ===== Card Styling ===== */
      .card {
        border-radius: 12px; /* smooth edges */
        border: 1px solid #e0e0e0; /* subtle border */
      }

      /* Upvote button style */
      .btn-outline-success {
        border-radius: 20px;
        font-weight: 500;
      }

      /* Layout for the upvote section */
      .upvote-section {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      /* Smooth fade animation for suggestion box */
      #categorySuggestions {
        transition: opacity 0.2s ease, visibility 0.2s ease;
        opacity: 0;
        visibility: hidden;
      }

      /* When visible, fade in */
      #categorySuggestions.show {
        opacity: 1;
        visibility: visible;
      }

      /* ===== Hover effect for category suggestions ===== */
      .suggestion-item {
        transition: background-color 0.15s ease, color 0.15s ease;
      }

      /* On hover â€” change background & text color */
      .suggestion-item:hover {
        background-color: #e7f1ff; /* soft blue */
        color: #0d6efd; /* Bootstrap blue text */
      }

      /* Optional: make the "Create new category" button distinct */
      .create-category {
        font-weight: 500;
        color: #0d6efd;
        cursor: pointer;
      }

      .create-category:hover {
        background-color: #eef5ff;
      }
    </style>
  </head>

  <body class="bg-light">
    <!-- ====== MAIN CONTAINER ====== -->
    <div class="container py-5">
      <!-- ====== Page Title ====== -->
      <h1 class="text-center mb-5">Crow ðŸª¶ Community Feed</h1>

      <!-- ========================== -->
      <!-- SUCCESS / INFO MESSAGES -->
      <!-- ========================== -->
      {% if messages %} {% for message in messages %}
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      {% endfor %} {% endif %}

      <!-- ================================================== -->
      <!--  SECTION 1 : CREATE A POST                         -->
      <!-- ================================================== -->
      <div class="card shadow-sm mb-5">
        <div class="card-body">
          <!-- Section title -->
          <h4 class="card-title mb-3">Create a Post</h4>

          <!-- ========= POST CREATION FORM ========= -->
          <!-- This form lets users add new posts -->
          <form method="POST" class="mb-4">
            {% csrf_token %}

            <!-- Post Title Input -->
            {{ form.title.label_tag }} {{ form.title }}

            <!-- Post Content Box -->
            {{ form.content.label_tag }} {{ form.content }}

            <!-- ========================== -->
            <!-- Category Search Input -->
            <!-- ========================== -->
            <!-- When user types here, suggestions appear below (using JS + AJAX) -->
            <label for="categoryInput" class="form-label mt-3">Category</label>
            <!-- User types category name here -->
            <input
              type="text"
              id="categoryInput"
              name="category_name"
              class="form-control"
              placeholder="Start typing a category..."
            />

            <!-- Suggestion list (hidden by default, will show results below input) -->
            <div
              id="categorySuggestions"
              class="border rounded bg-white mt-1"
              style="position: absolute; z-index: 1000; width: 92%"
            ></div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary mt-3">
              Share Post
            </button>
          </form>
        </div>
      </div>

      <!-- ================================================== -->
      <!--  SECTION 2 : DISPLAY ALL EXISTING POSTS             -->
      <!-- ================================================== -->
      <h3 class="fw-semibold mb-4">Latest Posts</h3>

      <!-- Loop through all posts from database -->
      {% for post in posts %}
      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <!-- Post title -->
          <h5 class="card-title mb-1">{{ post.title }}</h5>

          <!-- Post author and creation time -->
          <h6 class="card-subtitle mb-3 text-muted">
            by {{ post.author.username }} â€¢ {{ post.created_at|naturaltime }}
          </h6>

          <!-- Main post content -->
          <p class="card-text">{{ post.content }}</p>

          <!-- Display category name if available -->
          {% if post.category %}
          <p class="text-secondary">
            <small>Category: {{ post.category.name }}</small>
          </p>
          {% endif %}

          <!-- ========================== -->
          <!-- Upvote Button Section -->
          <!-- ========================== -->
          <!-- Clicking this increases the post's upvote count -->
          <form
            action="{% url 'upvote_post' post.id %}"
            method="post"
            class="upvote-section"
          >
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-success btn-sm">
              ðŸ”¥ Upvote
            </button>
            <span class="text-secondary">{{ post.upvotes }} upvotes</span>
          </form>
        </div>
      </div>

      <!-- If there are no posts at all, show a message -->
      {% empty %}
      <p class="text-muted">No posts yet. Be the first to share something!</p>
      {% endfor %}
    </div>

    <!-- ================================================== -->
    <!--  BOOTSTRAP JS (for dropdowns, buttons, etc.)        -->
    <!-- ================================================== -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ================================================== -->
    <!--  CATEGORY AUTO-SUGGEST + CREATE FEATURE -->
    <!-- ================================================== -->
   <script>
/*
This script runs every time the user types in the category input.
It:
1. Fetches category suggestions from Django (/categories/search/).
2. Displays them live below the input.
3. Lets user create a new category instantly via AJAX (/categories/create/).
*/

// Get references to HTML elements
const input = document.getElementById("categoryInput");
const suggestionBox = document.getElementById("categorySuggestions");

// Helper to safely get CSRF token from cookies (required for POST)
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === name + "=") {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// Run this whenever user types
input.addEventListener("keyup", function () {
  const query = input.value.trim();

  // If nothing typed, hide suggestion box
  if (!query) {
    suggestionBox.classList.remove("show");
    suggestionBox.innerHTML = "";
    return;
  }

  // Fetch category suggestions from backend
  fetch(`/categories/search/?q=${encodeURIComponent(query)}`)
    .then((response) => response.json())
    .then((data) => {
      const results = data.results || [];
      const exists = data.exists;
      const typed = data.typed;

      // Hide box if exact match exists
      if (exists) {
        suggestionBox.classList.remove("show");
        suggestionBox.innerHTML = "";
        return;
      }

      // Build suggestion list
      let html = "";
      if (results.length > 0) {
        html += results
          .map(
            (item) =>
              `<div class="p-2 suggestion-item" style="cursor:pointer">${item}</div>`
          )
          .join("");
      }

      // Add "Create new category" option
      if (!exists && typed.length > 0) {
        html += `<div class="p-2 text-primary fw-semibold suggestion-create" style="cursor:pointer; background-color:#f8f9fa;">
                  âž• Create "${typed}" category
                </div>`;
      }

      // If nothing to show
      if (html === "") {
        html = '<div class="p-2 text-muted">No categories found</div>';
      }

      // Insert HTML and show
      suggestionBox.innerHTML = html;
      suggestionBox.classList.add("show");

      // Click on existing category
      document.querySelectorAll(".suggestion-item").forEach((item) => {
        item.addEventListener("click", () => {
          input.value = item.textContent;
          suggestionBox.classList.remove("show");
        });
      });

      // Click outside hides box
      document.addEventListener("click", function (e) {
        if (
          !e.target.closest("#categoryInput") &&
          !e.target.closest("#categorySuggestions")
        ) {
          suggestionBox.classList.remove("show");
        }
      });

      // Create new category click
      const createOption = document.querySelector(".suggestion-create");
      if (createOption) {
        createOption.addEventListener("click", () => {
          const categoryName = typed;

          fetch("/categories/create/", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": getCookie("csrftoken"), // important!
            },
            body: `name=${encodeURIComponent(categoryName)}`,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                input.value = data.name;
                suggestionBox.classList.remove("show");
                alert(
                  data.created
                    ? `New category "${data.name}" created!`
                    : `Category "${data.name}" already existed.`
                );
              } else {
                alert("Could not create category: " + data.error);
              }
            })
            .catch((error) =>
              console.error("Error creating category:", error)
            );
        });
      }
    })
    .catch((error) => console.error("Error fetching categories:", error));
});
</script>


  </body>
</html>
