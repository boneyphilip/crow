{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Crow â€“ Community Feed</title>

    <!-- Bootstrap CSS (for responsive layout & styling) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      /* ===== Page-wide styling ===== */
      body {
        background-color: #f6f7f8; /* light gray background like Reddit */
        font-family: "Inter", "Segoe UI", Arial, sans-serif; /* clean readable font */
      }

      h1 {
        font-weight: 700;
        color: #212529; /* dark gray text */
      }

      /* ===== Card Styling ===== */
      .card {
        border-radius: 12px; /* smooth edges */
        border: 1px solid #e0e0e0; /* subtle border */
      }

      /* Upvote button style */
      .btn-outline-success {
        border-radius: 20px;
        font-weight: 500;
      }

      /* Layout for the upvote section */
      .upvote-section {
        display: flex;
        align-items: center;
        gap: 6px;
      }
    </style>
  </head>

  <body class="bg-light">
    <!-- ====== MAIN CONTAINER ====== -->
    <div class="container py-5">
      <!-- ====== Page Title ====== -->
      <h1 class="text-center mb-5">Crow ðŸª¶ Community Feed</h1>

      <!-- ========================== -->
      <!-- SUCCESS / INFO MESSAGES -->
      <!-- ========================== -->
      {% if messages %} {% for message in messages %}
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      {% endfor %} {% endif %}

      <!-- ================================================== -->
      <!--  SECTION 1 : CREATE A POST                         -->
      <!-- ================================================== -->
      <div class="card shadow-sm mb-5">
        <div class="card-body">
          <!-- Section title -->
          <h4 class="card-title mb-3">Create a Post</h4>

          <!-- ========= POST CREATION FORM ========= -->
          <!-- This form lets users add new posts -->
          <form method="POST" class="mb-4">
            {% csrf_token %}

            <!-- Post Title Input -->
            {{ form.title.label_tag }} {{ form.title }}

            <!-- Post Content Box -->
            {{ form.content.label_tag }} {{ form.content }}

            <!-- ========================== -->
            <!-- Category Search Input -->
            <!-- ========================== -->
            <!-- When user types here, suggestions appear below (using JS + AJAX) -->
            <label for="categoryInput" class="form-label mt-3">Category</label>
            <!-- User types category name here -->
            <input
              type="text"
              id="categoryInput"
              name="category_name"
              class="form-control"
              placeholder="Start typing a category..."
            />

            <!-- Suggestion list (hidden by default, will show results below input) -->
            <div
              id="categorySuggestions"
              class="border rounded bg-white mt-1"
              style="
                display: none;
                position: absolute;
                z-index: 1000;
                width: 92%;
              "
            ></div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary mt-3">
              Share Post
            </button>
          </form>
        </div>
      </div>

      <!-- ================================================== -->
      <!--  SECTION 2 : DISPLAY ALL EXISTING POSTS             -->
      <!-- ================================================== -->
      <h3 class="fw-semibold mb-4">Latest Posts</h3>

      <!-- Loop through all posts from database -->
      {% for post in posts %}
      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <!-- Post title -->
          <h5 class="card-title mb-1">{{ post.title }}</h5>

          <!-- Post author and creation time -->
          <h6 class="card-subtitle mb-3 text-muted">
            by {{ post.author.username }} â€¢ {{ post.created_at|date:"M d, Y H:i" }}
          </h6>

          <!-- Main post content -->
          <p class="card-text">{{ post.content }}</p>

          <!-- Display category name if available -->
          {% if post.category %}
          <p class="text-secondary">
            <small>Category: {{ post.category.name }}</small>
          </p>
          {% endif %}

          <!-- ========================== -->
          <!-- Upvote Button Section -->
          <!-- ========================== -->
          <!-- Clicking this increases the post's upvote count -->
          <form
            action="{% url 'upvote_post' post.id %}"
            method="post"
            class="upvote-section"
          >
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-success btn-sm">
              ðŸ”¥ Upvote
            </button>
            <span class="text-secondary">{{ post.upvotes }} upvotes</span>
          </form>
        </div>
      </div>

      <!-- If there are no posts at all, show a message -->
      {% empty %}
      <p class="text-muted">No posts yet. Be the first to share something!</p>
      {% endfor %}
    </div>

    <!-- ================================================== -->
    <!--  BOOTSTRAP JS (for dropdowns, buttons, etc.)        -->
    <!-- ================================================== -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ================================================== -->
    <!--  AJAX SCRIPT : CATEGORY SEARCH (Live Suggestion)    -->
    <!-- ================================================== -->
    <script>
      /*
This script runs in browser and connects the "categoryInput" box
to our Django backend using AJAX (fetch API).
It shows a list of matching categories as user types.
*/
      const input = document.getElementById("categoryInput"); // text input box
      const suggestionBox = document.getElementById("categorySuggestions"); // suggestion box below input

      // This event runs every time the user types a key
      input.addEventListener("keyup", function () {
        const query = input.value.trim(); // get what user typed

        // If nothing typed, hide suggestions
        if (!query) {
          suggestionBox.style.display = "none";
          suggestionBox.innerHTML = "";
          return;
        }

        // Send AJAX request to backend API
        fetch(`/categories/search/?q=${query}`)
          .then((response) => response.json()) // convert response to JSON
          .then((data) => {
            const results = data.results; // get list of matching categories

            // If we have results, display them
            if (results.length > 0) {
              suggestionBox.innerHTML = results
                .map(
                  (item) =>
                    `<div class="p-2 suggestion-item" style="cursor:pointer">${item}</div>`
                )
                .join("");
              suggestionBox.style.display = "block";
            } else {
              // No results found message
              suggestionBox.innerHTML =
                '<div class="p-2 text-muted">No categories found</div>';
              suggestionBox.style.display = "block";
            }

            // If user clicks on a suggestion â†’ fill box and hide suggestions
            document.querySelectorAll(".suggestion-item").forEach((item) => {
              item.addEventListener("click", () => {
                input.value = item.textContent;
                suggestionBox.style.display = "none";
              });
            });
          })
          .catch((error) => console.error("Error fetching categories:", error));
      });
    </script>
  </body>
</html>
